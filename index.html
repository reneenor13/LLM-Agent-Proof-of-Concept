<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Agent POC - Multi-Tool Reasoning</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; }
        .chat-container { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-height: 70vh; 
            overflow-y: auto;
        }
        .message { margin-bottom: 15px; padding: 12px 18px; border-radius: 12px; }
        .user-message { background: #007bff; color: white; margin-left: 20%; }
        .agent-message { background: #f8f9fa; border-left: 4px solid #28a745; }
        .tool-call { background: #fff3cd; border-left: 4px solid #ffc107; font-family: monospace; }
        .tool-result { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .loading { opacity: 0.7; }
        .tool-badge { font-size: 0.8em; margin-bottom: 5px; }
        pre { max-height: 200px; overflow-y: auto; }
        .model-info { font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="text-center mb-4 text-white">
            <h1><i class="fas fa-robot"></i> LLM Agent POC</h1>
            <p class="lead">Browser-Based Multi-Tool Reasoning Agent</p>
        </div>

        <!-- Configuration Panel -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">LLM Provider</label>
                        <select id="provider" class="form-select">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Model</label>
                        <select id="model" class="form-select">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="claude-3">Claude 3</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">API Key</label>
                        <input type="password" id="apiKey" class="form-control" placeholder="Enter your API key">
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Chat Interface -->
        <div class="card chat-container mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-comments"></i> Agent Conversation</h5>
            </div>
            <div class="card-body" id="chatMessages">
                <div class="message agent-message">
                    <strong>Agent:</strong> Hello! I'm your LLM agent. I can search the web, execute code, and use AI workflows. What would you like me to help you with?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="card">
            <div class="card-body">
                <div class="input-group">
                    <input type="text" id="userInput" class="form-control" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 text-white">
            <small>Built with OpenAI Tool Calling • Google Search • AI Pipe • Code Execution</small>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let conversation = [];
        let isProcessing = false;

        // Available tools configuration
        const TOOLS = [
            {
                type: "function",
                function: {
                    name: "google_search",
                    description: "Search Google for information and return snippet results",
                    parameters: {
                        type: "object",
                        properties: {
                            query: { type: "string", description: "Search query" }
                        },
                        required: ["query"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "ai_pipe",
                    description: "Use AI Pipe proxy for flexible AI dataflows and processing",
                    parameters: {
                        type: "object",
                        properties: {
                            workflow: { type: "string", description: "AI workflow to execute" },
                            data: { type: "string", description: "Input data for the workflow" }
                        },
                        required: ["workflow", "data"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "execute_code",
                    description: "Execute JavaScript code in the browser and return results",
                    parameters: {
                        type: "object",
                        properties: {
                            code: { type: "string", description: "JavaScript code to execute" }
                        },
                        required: ["code"]
                    }
                }
            }
        ];

        // Initialize conversation with system message
        conversation.push({
            role: "system",
            content: `You are a helpful AI agent with access to tools. You can:
1. Search Google for information
2. Use AI Pipe workflows for data processing
3. Execute JavaScript code in the browser

Always be conversational and explain what you're doing. Use tools when they would be helpful to answer the user's question.`
        });

        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        function addMessage(role, content, isToolCall = false, toolName = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let className = 'message ';
            let icon = '';
            let prefix = '';
            
            if (role === 'user') {
                className += 'user-message';
                icon = '<i class="fas fa-user"></i>';
                prefix = 'You:';
            } else if (role === 'assistant') {
                className += 'agent-message';
                icon = '<i class="fas fa-robot"></i>';
                prefix = 'Agent:';
            } else if (isToolCall) {
                className += 'tool-call';
                icon = '<i class="fas fa-cog"></i>';
                prefix = `Tool Call (${toolName}):`;
            } else {
                className += 'tool-result';
                icon = '<i class="fas fa-check-circle"></i>';
                prefix = `Tool Result (${toolName}):`;
            }
            
            messageDiv.className = className;
            
            if (isToolCall && toolName) {
                messageDiv.innerHTML = `
                    <div class="tool-badge">
                        <span class="badge bg-warning">${toolName}</span>
                    </div>
                    ${icon} <strong>${prefix}</strong><br>
                    <pre>${content}</pre>`;
            } else {
                messageDiv.innerHTML = `${icon} <strong>${prefix}</strong> ${content}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleKeyPress(event) {
            if (event.key === 'Enter') {
                await sendMessage();
            }
        }

        async function sendMessage() {
            if (isProcessing) return;
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // Validate API key
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showAlert('Please enter your API key to continue.');
                return;
            }
            
            isProcessing = true;
            userInput.value = '';
            
            // Add user message
            addMessage('user', message);
            conversation.push({ role: "user", content: message });
            
            try {
                await agentLoop();
            } catch (error) {
                console.error('Error in agent loop:', error);
                showAlert(`Error: ${error.message}`);
            } finally {
                isProcessing = false;
            }
        }

        async function agentLoop() {
            let continueTool = true;
            
            while (continueTool) {
                // Call LLM
                const response = await callLLM();
                
                // Add agent response if there's content
                if (response.content) {
                    addMessage('assistant', response.content);
                }
                
                // Handle tool calls
                if (response.tool_calls && response.tool_calls.length > 0) {
                    for (const toolCall of response.tool_calls) {
                        // Show tool call
                        addMessage('system', JSON.stringify(toolCall.function, null, 2), true, toolCall.function.name);
                        
                        // Execute tool
                        const toolResult = await executeToolCall(toolCall);
                        
                        // Show tool result
                        addMessage('system', toolResult, false, toolCall.function.name);
                        
                        // Add to conversation
                        conversation.push({
                            role: "tool",
                            tool_call_id: toolCall.id,
                            name: toolCall.function.name,
                            content: toolResult
                        });
                    }
                } else {
                    continueTool = false;
                }
            }
        }

        async function callLLM() {
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // Simulate API call (replace with actual API call)
            const response = await simulateLLMCall({
                model: model,
                messages: conversation,
                tools: TOOLS,
                tool_choice: "auto"
            });
            
            conversation.push({
                role: "assistant",
                content: response.content || null,
                tool_calls: response.tool_calls || null
            });
            
            return response;
        }

        // Simulated LLM response (replace with actual API integration)
        async function simulateLLMCall(request) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const lastMessage = request.messages[request.messages.length - 1];
            
            // Simple pattern matching for demo
            if (lastMessage.content.toLowerCase().includes('search')) {
                return {
                    content: "I'll search for that information.",
                    tool_calls: [{
                        id: "call_" + Date.now(),
                        type: "function",
                        function: {
                            name: "google_search",
                            arguments: JSON.stringify({
                                query: lastMessage.content.replace(/search|for|about/gi, '').trim()
                            })
                        }
                    }]
                };
            } else if (lastMessage.content.toLowerCase().includes('code') || lastMessage.content.toLowerCase().includes('calculate')) {
                return {
                    content: "I'll execute some code to help with that.",
                    tool_calls: [{
                        id: "call_" + Date.now(),
                        type: "function",
                        function: {
                            name: "execute_code",
                            arguments: JSON.stringify({
                                code: "console.log('Hello from executed code!'); return new Date().toLocaleString();"
                            })
                        }
                    }]
                };
            } else {
                return {
                    content: "I understand! How can I help you further? I can search for information, execute code, or use AI workflows.",
                    tool_calls: null
                };
            }
        }

        async function executeToolCall(toolCall) {
            const functionName = toolCall.function.name;
            const args = JSON.parse(toolCall.function.arguments);
            
            try {
                switch (functionName) {
                    case 'google_search':
                        return await googleSearch(args.query);
                    
                    case 'ai_pipe':
                        return await aiPipe(args.workflow, args.data);
                    
                    case 'execute_code':
                        return await executeCode(args.code);
                    
                    default:
                        return `Unknown tool: ${functionName}`;
                }
            } catch (error) {
                return `Error executing ${functionName}: ${error.message}`;
            }
        }

        async function googleSearch(query) {
            // Simulate Google Search (replace with actual Google Search API)
            await new Promise(resolve => setTimeout(resolve, 800));
            
            return JSON.stringify({
                query: query,
                results: [
                    {
                        title: `Search results for: ${query}`,
                        snippet: `This is a simulated search result for "${query}". In a real implementation, this would connect to Google's Custom Search API.`,
                        url: "https://example.com/search-result"
                    },
                    {
                        title: "Related information",
                        snippet: "Additional context and information related to your search query would appear here.",
                        url: "https://example.com/related-info"
                    }
                ]
            }, null, 2);
        }

        async function aiPipe(workflow, data) {
            // Simulate AI Pipe API (replace with actual AI Pipe integration)
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            return JSON.stringify({
                workflow: workflow,
                input: data,
                result: `AI Pipe workflow "${workflow}" processed successfully. Input: "${data}". This would connect to actual AI Pipe proxy in production.`,
                status: "completed"
            }, null, 2);
        }

        async function executeCode(code) {
            try {
                // Create a safe execution context
                const result = new Function(`
                    "use strict";
                    const console = {
                        log: (...args) => window.codeOutput.push(args.join(' '))
                    };
                    window.codeOutput = [];
                    
                    try {
                        const result = (function() {
                            ${code}
                        })();
                        
                        return {
                            result: result,
                            output: window.codeOutput,
                            success: true
                        };
                    } catch (error) {
                        return {
                            error: error.message,
                            success: false
                        };
                    }
                `)();
                
                if (result.success) {
                    return JSON.stringify({
                        code: code,
                        result: result.result,
                        console_output: result.output,
                        status: "success"
                    }, null, 2);
                } else {
                    return JSON.stringify({
                        code: code,
                        error: result.error,
                        status: "error"
                    }, null, 2);
                }
            } catch (error) {
                return JSON.stringify({
                    code: code,
                    error: error.message,
                    status: "error"
                }, null, 2);
            }
        }

        // Update model options based on provider
        document.getElementById('provider').addEventListener('change', function() {
            const modelSelect = document.getElementById('model');
            const provider = this.value;
            
            modelSelect.innerHTML = '';
            
            const models = {
                openai: ['gpt-4', 'gpt-3.5-turbo', 'gpt-4-turbo'],
                anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],
                google: ['gemini-pro', 'gemini-pro-vision']
            };
            
            models[provider].forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showAlert('Demo mode: Replace API simulation with real integrations for production use.', 'info');
        });
    </script>
</body>
</html>
